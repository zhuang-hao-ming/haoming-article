
---
title: postgis笔记
date: 2017-09-15 22:54:44
tags:
---
        
## 什么是空间数据库

一个空间数据库是一个普通的数据库，但是具有一下3个额外的特征。

### 空间数据类型

普通的数据库列的数据类型可以是char，int，date等。空间数据库增加了新的类型用来存储几何要素。一般有以下这些类型：

1. GEOMETRY 几何类型的基类
2. POINT 点几何类型（2维或多维）
3. LINESTRING 线串几何类型（两个或多个POINT组成，相邻的POINT线性连接）
4. LINERING 线环几何类型（起点和终点相同的LINESTRING）
5. POLYGON 多边形几何类型（一个或多个LINERING，一个外环和多个内环，内环定义洞）
6. MULTIPOINT 多点几何类型
7. MULTILINESTRING 多线串几何类型
8. MULTIPOLYGON 多多边形几何类型
8. GEOMETRYCOLLECTION 异质几何体集合类型


### 空间索引

普通的数据库对普通数据类型建立索引来提高数据的访问效率。普通数据类型存在自然顺序关系（一个数据大于小于或者等于另一个数据），索引利用了这种关系。如B-tree索引，它利用这种关系建立一个层次树，来提高数据的访问效率。

几何类型中不存在这样的自然顺序关系，所以不能够用B-tree索引。几何类型的数据之间存在空间关系（相交与否等）。可以利用这种关系来建立索引，但考虑到几何类型的求交运算的复杂度太高，一般会向对几何体建立外包矩形，然后再利用外包矩形的空间关系建立索引。

**因为使用了外包矩形来建立索引，所以空间索引只能提供近似的结果，而普通索引可以提供精确的结果**

常见的空间索引有：
1. R-tree（postgis）
2. quadtree
3. grid
4. 

### postgis中建立空间索引

```
CREATE index_name ON table_name USING GIST(column_name)

VACUUM ANALYZE table_name;

CLUSTER table_name USING index_name;

ANALYZE table_name;

```

1. 首先在几何列建立GIST空间索引，GIST指示在外包矩形上建立空间所以，如果不指示GIST，那么数据库将直接在几何体上建立索引，这导致索引空间过大，可能出错，也不利于查找效率。
2. 使用VACUUM table_name来回收因为建立索引，插入，删除，更新，导致的未被利用的表空间
3. 使用ANALYZE table_name来遍历变，重新设计查询计划
4. 2，3命令可以一起使用如代码所示
5. 在建立完成索引后需要执行23操作，才能提升性能。
6. 数据库默认会自动VACUUM，但是在建立索引或者批量插入后应该手动VACUUM。


### 空间函数

普通的数据库提供了一些函数在查询时对基础数据类型进行操作。比如，对字符串进行连接，对数字进行数学运算。空间数据库需要提供一些函数来对几何类型的数据进行操作。

空间函数分为以下几大类：

1. 构建： 从文本或二进制的几何体数据表达构建几何体类型的字段
2. 序列化： 将几何体字段的数据输出为文本或二进制格式。（JSON）
3. 谓词： 测试几何体之间是否有某种关系，返回true/false
4. 测量： 返回几何体的面积，长度等
5. 获取： 从几何体中抽取内容，如从LINESTRING中得到POINT
6. 构建： 构建新的几何体，如缓冲区生成，外包矩形生成，并
7. 聚集： 从多个几何体中得到结果


### 总结

上述讨论的这3个特征的具体规范在[simple feature access](http://www.opengeospatial.org/standards/sfa)中描述，不同的空间数据库对这个规范进行了改动和实现。


## 使用空间数据库相对于使用文件（shpaefile）的好处

1. 使用数据库可以利用数据库的事务来确保数据不会在多用户共同操作的情况下被污染。
2. 可以对大数据集进行统一操作，而不需要划分为多个小文件


## 为什么postgis被实现在postgresql上

postgresql的两个特性：

1. 类型扩展机制
2. generic index structure(GIST)

使得空间数据库的特征1和2很容易实现。而其它的数据库没有这两个特性。